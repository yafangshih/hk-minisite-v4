<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Nano Banana Playground</h1>
                <p class="text-gray-500 mt-2">Upload an image, type a prompt, and create a unique vision!</p>
            </header>

            <main class="grid md:grid-cols-2 gap-8">
                <!-- Left Column: Inputs -->
                <div class="space-y-6">
                    <div>
                        <label for="image-upload" class="block text-sm font-medium text-gray-700 mb-1">Upload Image</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="image-upload-input" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                        <span>Choose a file</span>
                                        <input id="image-upload-input" name="image-upload" type="file" class="sr-only" accept="image/*">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500" id="file-name">PNG, JPG up to 10MB</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="prompt" class="block text-sm font-medium text-gray-700 mb-1">Prompt</label>
                        <textarea id="prompt" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., A cat on the moon, pop art style"></textarea>
                    </div>
                    <button id="generate-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400">
                        Generate Image
                    </button>
                </div>

                <!-- Right Column: Preview & Result -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800">Preview & Result</h3>
                    <div id="image-preview-container" class="w-full aspect-square bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
                        <span class="text-gray-500">Image Preview</span>
                    </div>
                    <div id="result-container" class="w-full aspect-square bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden relative">
                         <div id="loader" class="loader hidden"></div>
                        <img id="result-image" src="" alt="Generated Image" class="hidden w-full h-full object-contain">
                        <span id="result-placeholder" class="text-gray-500">Generated image will appear here</span>
                    </div>
                    <!-- Mobile download tip -->
                    <p id="mobile-download-tip" class="text-center text-orange-700 bg-orange-100 font-medium p-2 rounded-lg text-sm mt-2 hidden md:hidden">
                        Press and hold the image to download
                    </p>
                    <!-- Desktop download tip (NEW) -->
                    <p id="desktop-download-tip" class="text-center text-indigo-700 bg-indigo-100 font-medium p-2 rounded-lg text-sm mt-2 hidden md:block">
                        Right-click and "Save image as..." to download
                    </p>
                </div>
            </main>

            <div id="message-box" class="fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
                <span id="message-text"></span>
            </div>
        </div>
        
        <!-- Disclaimer Footer -->
        <footer class="mt-6 text-xs text-gray-500 text-left space-y-2">
            <p><strong>Disclaimers:</strong> This demonstration site is intended for informational and illustrative purposes during this event only. All services are provided 'as-is' without warranties of any kind.</p>
            <p>AI-generated content may contain inaccuracies, artifacts, or offensive material. Please review all outputs carefully. Please refrain from entering any personal, confidential, or sensitive proprietary information, as inputs may be logged.</p>
            <p>Content generated from this site is for demonstration purposes only and is not licensed for commercial or public use. We assume no liability for any decisions or actions taken based on the content generated.</p>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const imageUploadInput = document.getElementById('image-upload-input');
        const fileNameDisplay = document.getElementById('file-name');
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generate-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const resultContainer = document.getElementById('result-container');
        const loader = document.getElementById('loader');
        const resultImage = document.getElementById('result-image');
        const resultPlaceholder = document.getElementById('result-placeholder');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const mobileDownloadTip = document.getElementById('mobile-download-tip'); 
        const desktopDownloadTip = document.getElementById('desktop-download-tip'); // (NEW)

        // --- State ---
        let uploadedFile = null;

        // --- Event Listeners ---
        imageUploadInput.addEventListener('change', handleImageUpload);
        generateBtn.addEventListener('click', handleGenerateImage);

        // --- Functions ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            uploadedFile = file;
            fileNameDisplay.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreviewContainer.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-contain">`;
            };
            reader.readAsDataURL(file);
        }

        async function handleGenerateImage() {
            if (!uploadedFile || !promptInput.value.trim()) {
                showMessage("Please upload an image and enter a prompt!", "error");
                return;
            }

            setLoading(true);
            resultImage.classList.add('hidden');
            resultPlaceholder.classList.add('hidden');
            mobileDownloadTip.classList.add('hidden'); // Hide tip
            desktopDownloadTip.classList.add('hidden'); // (NEW) Hide tip

            try {
                const base64ImageData = await fileToBase64(uploadedFile);
                
                const apiUrl = `/generate`; 
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: promptInput.value },
                            { inlineData: { mimeType: uploadedFile.type, data: base64ImageData.split(',')[1] } }
                        ]
                    }]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'An error occurred on the backend server.');
                }
                
                console.log("Full API Response from backend:", JSON.stringify(result, null, 2));

                const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                
                if (imagePart) {
                    const generatedImageBase64 = imagePart.inlineData.data;
                    const mimeType = imagePart.inlineData.mimeType;
                    resultImage.src = `data:${mimeType};base64,${generatedImageBase64}`;
                    resultImage.classList.remove('hidden');
                    mobileDownloadTip.classList.remove('hidden'); // Show tip
                    desktopDownloadTip.classList.remove('hidden'); // (NEW) Show tip
                    showMessage("Image generated successfully!");
                } else {
                    let detailedError = "No image data found in the API response.";
                    if (result?.candidates?.[0]?.finishReason === 'SAFETY') {
                        detailedError += " This might be due to the safety filter. Please try a different image or prompt.";
                    } else if (result.error) {
                        detailedError = result.error.message;
                    }
                    throw new Error(detailedError);
t                }

            } catch (error) {
                console.error('Error generating image:', error);
                showMessage(`Generation failed: ${error.message}`, "error");
                resultPlaceholder.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            loader.classList.toggle('hidden', !isLoading);
        }

        function showMessage(text, type = 'success') {
            messageText.textContent = text;
            messageBox.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-100 transition-opacity duration-300'; // Reset classes
            messageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            setTimeout(() => {
                messageBox.classList.replace('opacity-100', 'opacity-0');
            }, 3000);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>

